{{ template "basetop" . }}

<div class="overflow-hidden w-full overflow-x-auto">
    <div class="flex mb-4">
        <h2 class="text-2xl font-bold">Configured SCION Links</h2>
        <div x-data="{modalIsOpen: false}" class="ml-auto">
            <button x-on:click="modalIsOpen = true" type="button"
                class="whitespace-nowrap rounded-radius border border-primary dark:border-primary-dark bg-primary px-4 py-2 text-center text-sm font-medium tracking-wide text-on-primary transition hover:opacity-75 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary active:opacity-100 active:outline-offset-0 dark:bg-primary-dark dark:text-on-primary-dark dark:focus-visible:outline-primary-dark">Add
                SCION Link</button>
            <div x-cloak x-show="modalIsOpen" x-transition.opacity.duration.200ms x-trap.inert.noscroll="modalIsOpen"
                x-on:keydown.esc.window="modalIsOpen = false"
                class="fixed inset-0 z-30 flex items-end justify-center bg-black/20 p-4 pb-8 backdrop-blur-md sm:items-center lg:p-8"
                role="dialog" aria-modal="true" aria-labelledby="defaultModalTitle" style="display: none;">
                <!-- Modal Dialog -->
                <div x-show="modalIsOpen"
                    x-transition:enter="transition ease-out duration-200 delay-100 motion-reduce:transition-opacity"
                    x-transition:enter-start="opacity-0 scale-50" x-transition:enter-end="opacity-100 scale-100"
                    class="flex max-w-lg flex-col gap-4 overflow-hidden rounded-radius border border-outline bg-surface text-on-surface dark:border-outline-dark dark:bg-surface-dark-alt dark:text-on-surface-dark">
                    <!-- Dialog Header -->
                    <div
                        class="flex items-center justify-between border-b border-outline bg-surface-alt/60 p-4 dark:border-outline-dark dark:bg-surface-dark/20">
                        <h3 id="defaultModalTitle"
                            class="font-semibold tracking-wide text-on-surface-strong dark:text-on-surface-dark-strong">
                            Add SCION Link</h3>
                        <button x-on:click="modalIsOpen = false" aria-label="close modal">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true"
                                stroke="currentColor" fill="none" stroke-width="1.4" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <!-- Dialog Body -->
                    <div class="px-4 py-8">

                        <div
                            class="relative flex w-full max-w-xs flex-col gap-1 text-on-surface dark:text-on-surface-dark mb-3">
                            <label for="border_router" class="w-fit pl-0.5 text-sm">Border Router</label>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                                class="absolute pointer-events-none right-4 top-8 size-5">
                                <path fill-rule="evenodd"
                                    d="M5.22 8.22a.75.75 0 0 1 1.06 0L10 11.94l3.72-3.72a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.22 9.28a.75.75 0 0 1 0-1.06Z"
                                    clip-rule="evenodd" />
                            </svg>
                            <select id="border_router" name="border_router"
                                class="w-full appearance-none rounded-radius border border-outline bg-surface-alt px-4 py-2 text-sm focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary disabled:cursor-not-allowed disabled:opacity-75 dark:border-outline-dark dark:bg-surface-dark-alt/50 dark:focus-visible:outline-primary-dark">
                                <option value="br-1" selected>br-1</option>
                            </select>
                        </div>
                        <div class="flex w-full max-w-xs flex-col gap-1 text-on-surface dark:text-on-surface-dark mb-3">
                            <label for="neighbor" class="w-fit pl-0.5 text-sm">Neighbour ISD-AS</label>
                            <input id="neighbor" type="text"
                                class="w-full rounded-radius border border-outline bg-surface-alt px-2 py-2 text-sm focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary disabled:cursor-not-allowed disabled:opacity-75 dark:border-outline-dark dark:bg-surface-dark-alt/50 dark:focus-visible:outline-primary-dark"
                                name="name" placeholder="71-20391" />
                        </div>
                        <div class="flex w-full max-w-xs flex-col gap-1 text-on-surface dark:text-on-surface-dark mb-3">
                            <label for="local" class="w-fit pl-0.5 text-sm">Local</label>
                            <input id="local" type="text"
                                class="w-full rounded-radius border border-outline bg-surface-alt px-2 py-2 text-sm focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary disabled:cursor-not-allowed disabled:opacity-75 dark:border-outline-dark dark:bg-surface-dark-alt/50 dark:focus-visible:outline-primary-dark"
                                name="name" placeholder="127.0.0.1:50000" />
                        </div>
                        <div class="flex w-full max-w-xs flex-col gap-1 text-on-surface dark:text-on-surface-dark mb-3">
                            <label for="remote" class="w-fit pl-0.5 text-sm">Remote</label>
                            <input id="remote" type="text"
                                class="w-full rounded-radius border border-outline bg-surface-alt px-2 py-2 text-sm focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary disabled:cursor-not-allowed disabled:opacity-75 dark:border-outline-dark dark:bg-surface-dark-alt/50 dark:focus-visible:outline-primary-dark"
                                name="name" placeholder="192.168.0.1:50000" />
                        </div>
                        <div class="flex w-full max-w-xs flex-col gap-1 text-on-surface dark:text-on-surface-dark mb-3">
                            <label for="mtu" class="w-fit pl-0.5 text-sm">MTU</label>
                            <input id="mtu" type="number"
                                class="w-full rounded-radius border border-outline bg-surface-alt px-2 py-2 text-sm focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary disabled:cursor-not-allowed disabled:opacity-75 dark:border-outline-dark dark:bg-surface-dark-alt/50 dark:focus-visible:outline-primary-dark"
                                name="name" placeholder="1472" />
                        </div>
                        <div
                            class="relative flex w-full max-w-xs flex-col gap-1 text-on-surface dark:text-on-surface-dark mb-3">
                            <label for="link_type" class="w-fit pl-0.5 text-sm">Link to</label>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                                class="absolute pointer-events-none right-4 top-8 size-5">
                                <path fill-rule="evenodd"
                                    d="M5.22 8.22a.75.75 0 0 1 1.06 0L10 11.94l3.72-3.72a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.22 9.28a.75.75 0 0 1 0-1.06Z"
                                    clip-rule="evenodd" />
                            </svg>
                            <select id="link_type" name="link_type"
                                class="w-full appearance-none rounded-radius border border-outline bg-surface-alt px-4 py-2 text-sm focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary disabled:cursor-not-allowed disabled:opacity-75 dark:border-outline-dark dark:bg-surface-dark-alt/50 dark:focus-visible:outline-primary-dark">
                                <option value="CORE">Core</option>
                                <option value="PARENT">Parent</option>
                                <option value="CHILD">Child</option>
                                <option value="PEER">Peer</option>
                            </select>
                        </div>
                    </div>
                    <div id="error-message" class="px-4 text-sm text-danger hidden">
                    </div>
                    <!-- Dialog Footer -->
                    <div
                        class="flex flex-col-reverse justify-between gap-2 border-t border-outline bg-surface-alt/60 p-4 dark:border-outline-dark dark:bg-surface-dark/20 sm:flex-row sm:items-center md:justify-end">
                        <button x-on:click="modalIsOpen = false" type="button"
                            class="whitespace-nowrap rounded-radius px-4 py-2 text-center text-sm font-medium tracking-wide text-on-surface transition hover:opacity-75 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary active:opacity-100 active:outline-offset-0 dark:text-on-surface-dark dark:focus-visible:outline-primary-dark">Cancel</button>
                        <button type="button" id="button-save" onclick="addSCIONLink()"
                            class="whitespace-nowrap rounded-radius bg-primary border border-primary dark:border-primary-dark px-4 py-2 text-center text-sm font-medium tracking-wide text-on-primary transition hover:opacity-75 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary active:opacity-100 active:outline-offset-0 dark:bg-primary-dark dark:text-on-primary-dark dark:focus-visible:outline-primary-dark">Save</button>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <div x-data="scionRouterTable()" x-init="fetchData()">
        <table
            class="w-full text-left text-sm text-on-surface dark:text-on-surface-dark rounded-radius border border-outline dark:border-outline-dark">
            <thead
                class="border-b border-outline bg-surface-alt text-sm text-on-surface-strong dark:border-outline-dark dark:bg-surface-dark-alt dark:text-on-surface-dark-strong">
                <tr>
                    <th scope="col" class="p-4">Router</th>
                    <th scope="col" class="p-4">Interface ID</th>
                    <th scope="col" class="p-4">Local</th>
                    <th scope="col" class="p-4">Remote</th>
                    <th scope="col" class="p-4">Type</th>
                    <th scope="col" class="p-4">MTU</th>
                    <th scope="col" class="p-4">Status</th>
                    <th scope="col" class="p-4">Action</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-outline dark:divide-outline-dark">
                <template x-for="link in links" :key="link.InterfaceID">
                    <tr>
                        <td class="p-4" x-text="link.Router"></td>
                        <td class="p-4" x-text="link.InterfaceID"></td>
                        <td class="p-4" x-text="link.Local"></td>
                        <td class="p-4" x-text="link.Remote"></td>
                        <td class="p-4" x-text="link.LinkType"></td>
                        <td class="p-4" x-text="link.MTU"></td>
                        <td class="p-4">
                            <span
                                :class="link.Up ? 
                                'inline-flex overflow-hidden rounded-radius border-success px-1 py-0.5 text-xs font-medium text-success bg-success/10' : 
                                'inline-flex overflow-hidden rounded-radius border-danger px-1 py-0.5 text-xs font-medium text-danger bg-danger/10'"
                                x-text="link.Up ? 'Up' : 'Down'">
                            </span>
                        </td>
                        <td class="p-4">
                            <button type="button"
                                class="whitespace-nowrap rounded-radius bg-transparent p-0.5 font-semibold text-primary outline-primary hover:opacity-75 focus-visible:outline-2 focus-visible:outline-offset-2 active:opacity-100 active:outline-offset-0 dark:text-primary-dark dark:outline-primary-dark cursor-pointer">
                                Edit
                            </button>
                        </td>
                    </tr>
                </template>
            </tbody>
        </table>
    </div>

</div>

<script>
    function scionRouterTable() {
        return {
            links: [],
            async fetchData() {
                try {
                    const response = await fetch('/api/v1/as/links'); // Replace with the actual endpoint
                    this.links = await response.json();

                    if (!this.links) {
                        this.links = [];
                    }

                } catch (error) {
                    console.error("Error fetching router links:", error);
                }
            }
        }
    }

    function addSCIONLink() {
        data = {
            "border_router": document.getElementById("border_router").value,
            "neighbor": document.getElementById("neighbor").value,
            "local": document.getElementById("local").value,
            "remote": document.getElementById("remote").value,
            "link_type": document.getElementById("link_type").value,
            "mtu": parseInt(document.getElementById("mtu").value)
        }

        const errorBox = document.getElementById("error-message");
        const buttonSave = document.getElementById("button-save");
        errorBox.classList.add("hidden");
        errorBox.innerText = "";

        buttonSave.innerText = "Saving...";
        fetch('/api/v1/as/links', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        }).then(async response => {
            if (response.ok) {
                setTimeout(() => {
                    buttonSave.innerText = "Save";
                    window.location.reload();
                }, 2000);

            } else {
                buttonSave.innerText = "Save";
                console.error("Failed to add link");
                const returnErr = await response.json();
                errorBox.innerText = `Failed to add link: ${returnErr.error}`;
                errorBox.classList.remove("hidden");
            }
        }).catch(error => {
            buttonSave.innerText = "Save";
            console.error("Error adding link:", error);
            errorBox.innerText = `Unexpected error: ${error}`;
            errorBox.classList.remove("hidden");
        });
    }
</script>

{{ template "basebottom" . }}